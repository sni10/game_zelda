### Техническая архитектура двухслойной системы карт

Да, совершенно верно! Исходя из анализа технической документации, система должна работать с **двумя отдельными файлами карт** для каждой локации с привязанными координатами.

### Структура файлов карт

#### Основная карта поверхности (Z=0):
```
data/worlds/village_map.txt
```
- Содержит обычные тайлы мира: трава, деревья, дома, препятствия
- Размер: например, 64x48 тайлов
- Тайлы входов в тоннели: `tunnel_entrance_hatch` (триггеры)

#### Карта подземного слоя (Z=-1):
```
data/worlds/village_map_underground.txt
```
- **Тот же размер**: 64x48 тайлов (точная координатная привязка)
- **Тропинки пещер**: проходимые тайлы `tunnel_path`
- **Стены-ограничители**: непроходимые тайлы `tunnel_wall` по бокам тропинок
- **Пустые области**: `empty_underground` где нет тоннелей

### Принцип координатной привязки

#### Синхронизация координат:
```
Поверхность [32,16]: tunnel_entrance_hatch
Подземелье [32,16]: tunnel_path_start

Поверхность [33,16]: grass_tile  
Подземелье [33,16]: tunnel_path

Поверхность [34,16]: grass_tile
Подземелье [34,16]: tunnel_path_end
```

#### Система перекрытий:
- Игрок на Z=-1 в позиции [33,16] 
- Над ним на Z=0 находится `grass_tile`
- `RenderingSystem` отрисовывает траву полупрозрачной, показывая игрока "под землей"

### Техническая реализация

#### Загрузка двух карт одновременно:
```python
class WorldLoader:
    def load_location(self, location_name: str):
        # Загружаем основную карту
        surface_map = self.load_map_file(f"{location_name}.txt")
        
        # Загружаем подземную карту
        underground_map = self.load_map_file(f"{location_name}_underground.txt")
        
        # Проверяем совпадение размеров
        assert surface_map.size == underground_map.size
        
        return LayeredWorld(surface_map, underground_map)
```

#### Система рендеринга слоев:
```python
class LayerRenderer:
    def render_world(self, world: LayeredWorld, player_z: int):
        # Всегда рендерим оба слоя
        self.render_layer(world.underground_map, z_level=-1)
        self.render_layer(world.surface_map, z_level=0)
        
        # Применяем эффекты перекрытия
        if player_z == -1:
            self.apply_overlay_effects(world.surface_map)
```

### Структура тоннелей в подземной карте

#### Пример тропинки пещеры:
```
# village_map_underground.txt
. . . . . . . .    # пустые области
. W W W W W . .    # W = tunnel_wall (стены)
. W P P P W . .    # P = tunnel_path (тропинка)  
. W P P P W . .    # узкий проход 2 клетки
. W W W W W . .    # ограничители по бокам
. . . . . . . .
```

#### Соответствующая поверхность:
```
# village_map.txt  
G G G G G G G G    # G = grass_tile
G G T G G G G G    # T = tunnel_entrance_hatch
G G G G G G G G    # обычные тайлы поверхности
G G G G G G G G
G G G G G G G G
```

### Игровая логика переходов

#### Вход в тоннель:
1. Игрок взаимодействует с `tunnel_entrance_hatch` на Z=0
2. `ZTransitionSystem` переводит игрока на Z=-1
3. Позиция остается той же: [32,16]
4. Теперь игрок находится на `tunnel_path_start` подземной карты

#### Движение в тоннеле:
- Игрок может двигаться только по `tunnel_path` тайлам
- `tunnel_wall` блокируют движение (коллизии)
- Поверхность продолжает отрисовываться сверху с эффектами перекрытия

#### Выход из тоннеля:
- Достигнув `tunnel_path_end`, игрок возвращается на Z=0
- Появляется на соответствующем `tunnel_exit_hatch` поверхности

### Преимущества такой архитектуры

#### Гибкость дизайна:
- Можно создавать сложные системы тоннелей независимо от поверхности
- Легко добавлять новые подземные области
- Простое редактирование каждого слоя отдельно

#### Производительность:
- Обе карты загружаются один раз
- Нет необходимости в отдельных локациях для тоннелей
- Эффективное использование памяти

#### Визуальная целостность:
- Игрок всегда видит контекст: что происходит на поверхности
- Плавные переходы между слоями
- Ощущение настоящего трехмерного мира в 2D игре

### Файловая структура проекта

```
data/worlds/
├── village_map.txt              # поверхность
├── village_map_underground.txt  # подземелье
├── forest_map.txt               # поверхность
├── forest_map_underground.txt   # подземелье
└── swamp_map.txt               # поверхность
    swamp_map_underground.txt    # подземелье
```

Эта система позволяет создавать богатые многослойные локации, где каждый уровень дополняет другой, создавая ощущение глубины и сложности игрового мира без необходимости загрузки отдельных сцен.