# Issue #11: Система спутников (Братья и сестры)

## Описание
Реализация системы поиска, спасения и управления спутниками — выжившими братьями и сестрами главного героя. Спутники являются не просто NPC, а полноценными боевыми компаньонами с уникальными классами, специализациями и возможностью совместного участия в битвах.

## Цель
Усилить эмоциональную вовлеченность игрока через воссоединение семьи, добавить тактическую глубину в игровой процесс и наградить за исследование мира.

## Требования

### Система поиска и спасения
- [ ] **Квесты по спасению**:
  - [ ] Создать 5-7 уникальных квестов для спасения каждого брата/сестры.
  - [ ] Каждый квест должен включать исследование локации, решение головоломок или победу над мини-боссом.
- [ ] **Интеграция с сюжетом**:
  - [ ] Нахождение спутников должно быть вплетено в основной сюжет (например, информацию о них можно получать после победы над вождями варваров).
- [ ] **База (Кузня)**:
  - [ ] После спасения каждый спутник появляется в восстановленной кузне, предлагая свои услуги.

### Классы и специализации спутников
- [ ] **Разнообразие классов (минимум 5)**:
  - [ ] **Воин (Танк)**: Принимает урон на себя, провоцирует врагов.
  - [ ] **Охотник (Стрелок)**: Наносит урон с дистанции, использует ловушки.
  - [ ] **Целитель (Жрец)**: Восстанавливает здоровье игрока и союзников, накладывает защитные баффы.
  - [ ] **Разбойник (Ассасин)**: Наносит высокий урон одиночным целям, использует яды и ослабления.
  - [ ] **Маг (Чародей)**: Наносит урон по площади, контролирует группы врагов (заморозка, оглушение).
- [ ] **Уникальные способности**:
  - [ ] Каждый спутник должен иметь 2-3 уникальные активные или пассивные способности.
  - [ ] *Пример: Воин может использовать "Боевой клич" для провокации, а Целитель — "Круг исцеления".*
- [ ] **Пассивные бонусы**:
  - [ ] Находясь в кузне, каждый спутник дает постоянный бонус (например, скидку у торговцев, ускорение крафта, пассивную регенерацию здоровья).

### Боевая система и управление
- [ ] **Активный отряд**:
  - [ ] Игрок может выбрать до **трех** спутников для формирования активного отряда.
  - [ ] Возможность менять состав отряда в кузне или в специальных точках сохранения.
- [ ] **Искусственный интеллект (ИИ)**:
  - [ ] Спутники должны адекватно реагировать на боевую ситуацию (атаковать врагов, уклоняться от атак, использовать способности).
  - [ ] Базовые тактические установки (агрессивный, защитный, пассивный режимы).
- [ ] **Неуязвимость**:
  - [ ] Спутники не могут умереть окончательно. Получив критический урон, они выходят из боя на некоторое время для восстановления.
- [ ] **Команды игрока**:
  - [ ] Реализовать простую систему команд: "Атаковать мою цель", "Следовать за мной", "Защищать точку".

## Технические детали

### Архитектурные паттерны

#### ECS Components для системы спутников
```python
# src/core/ecs/companion_components.py
class CompanionComponent(Component):
    """Компонент, указывающий, что сущность является спутником."""
    def __init__(self, companion_id: str, companion_class: str):
        self.id = companion_id
        self.companion_class = companion_class
        self.is_in_party = False
        self.is_rescued = False

class CompanionAIComponent(Component):
    """Компонент для управления поведением спутника."""
    def __init__(self, behavior_tree: BehaviorTree):
        self.behavior_tree = behavior_tree # Дерево поведения для ИИ
        self.current_target = None
        self.tactical_mode = "aggressive" # "defensive", "passive"

class PartyManagerComponent(Component):
    """Компонент на игроке для управления отрядом."""
    def __init__(self, max_size: int = 3):
        self.active_party: list[Entity] = []
        self.max_party_size = max_size
```

#### State Pattern для состояний спутника
```python
# src/systems/ai/companion_states.py
class CompanionState(ABC):
    """Базовый класс состояния для ИИ спутника."""
    @abstractmethod
    def execute(self, companion: Entity, player: Entity, enemies: list[Entity]):
        pass

class FollowState(CompanionState):
    """Состояние следования за игроком."""
    def execute(self, companion, player, enemies):
        # Логика движения к игроку
        pass

class CombatState(CompanionState):
    """Боевое состояние."""
    def execute(self, companion, player, enemies):
        # Логика выбора цели и атаки
        pass

class DisabledState(CompanionState):
    """Состояние после получения критического урона."""
    def execute(self, companion, player, enemies):
        # Логика восстановления и возвращения в бой
        pass
```

### Структурные изменения проекта
```
src/
├── core/ecs/
│   └── companion_components.py   # Новые компоненты для спутников
├── systems/
│   ├── ai/
│   │   ├── companion_states.py   # Состояния ИИ
│   │   └── behavior_trees.py     # Деревья поведения
│   └── companion_system.py       # Основная система управления спутниками
├── quests/
│   └── rescue_quests/            # Директория для квестов по спасению
└── ui/
    └── party_management_ui.py    # UI для управления отрядом
```

## Критерии готовности
- [ ] Все 5-7 квестов по спасению реализованы и проходимы.
- [ ] Реализовано минимум 5 уникальных классов спутников со своими способностями.
- [ ] Игрок может формировать отряд из 3 спутников и управлять им.
- [ ] ИИ спутников адекватно ведет себя в бою и вне его.
- [ ] Система сохраняет информацию о спасенных спутниках и составе отряда.
- [ ] В финальных битвах спутники корректно участвуют в бою.

## Приоритет
**Высокий** - Ключевая механика, тесно связанная с сюжетом и геймплеем.

## Зависимости
- **Issue #05 (Враги)** - для боевого взаимодействия.
- **Issue #09 (Квесты)** - для создания квестов по спасению.
- **UI система** - для создания интерфейса управления отрядом.

---

## Подзадачи для реализации

### Фаза 1: Базовая структура и первый спутник
**Цель**: Создать основу системы и реализовать первого спутника-воина.

- [ ] **1.1. Компоненты**: Создать `CompanionComponent`, `CompanionAIComponent`, `PartyManagerComponent`.
- [ ] **1.2. Система**: Создать базовую `CompanionSystem` для регистрации спутников.
- [ ] **1.3. Первый квест**: Реализовать квест по спасению брата-воина.
- [ ] **1.4. ИИ Воина**: Создать простое дерево поведения для воина (следовать, атаковать ближайшего врага).
- [ ] **1.5. Интеграция в отряд**: Добавить механику включения спасенного воина в отряд.

### Фаза 2: Расширение классов и способностей
**Цель**: Добавить разнообразие в классы и способности спутников.

- [ ] **2.1. Реализация классов**: Создать префабы и логику для Охотника и Целителя.
- [ ] **2.2. Уникальные способности**: Реализовать по одной активной способности для первых трех классов (Воин, Охотник, Целитель).
- [ ] **2.3. Квесты**: Создать квесты по спасению для Охотника и Целителя.

### Фаза 3: Система управления и UI
**Цель**: Дать игроку возможность управлять своим отрядом.

- [ ] **3.1. UI управления**: Создать интерфейс `party_management_ui.py` для просмотра спутников и формирования отряда.
- [ ] **3.2. Система команд**: Реализовать базовые команды ("Атаковать", "Следовать").
- [ ] **3.3. Тактические режимы**: Добавить в ИИ переключение между агрессивным и защитным поведением.

### Фаза 4: Завершение и полировка
**Цель**: Реализовать всех оставшихся спутников и отполировать систему.

- [ ] **4.1. Оставшиеся классы**: Реализовать Разбойника и Мага.
- [ ] **4.2. Оставшиеся квесты**: Создать квесты для последних спутников.
- [ ] **4.3. Балансировка**: Сбалансировать урон, здоровье и способности всех спутников.
- [ ] **4.4. Тестирование**: Провести полное тестирование всех квестов и боевых сценариев с разными комбинациями отряда.
