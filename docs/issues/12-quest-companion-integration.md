# Issue #12: Интеграция спутников в квесты и развитие взаимоотношений

## Описание
Эта задача описывает углубленную интеграцию системы спутников (спасенных братьев и сестер) в квестовую систему и мир игры. Цель — сделать спутников не просто боевыми помощниками, а живыми персонажами, чье присутствие влияет на прохождение квестов, открывает новые сюжетные линии и обогащает мир через их личные истории и взаимоотношения.

## Цель
- Превратить спутников из пассивных компаньонов в активных участников истории.
- Создать уникальные геймплейные ситуации, зависящие от состава отряда.
- Сделать мир более живым и реактивным.
- Углубить эмоциональную связь игрока с его семьей.

## Требования

### 1. Персональные квестовые линии спутников
- [ ] **У каждого спутника есть своя история:** После спасения каждый брат/сестра получает собственную короткую квестовую цепочку (2-3 квеста), которая раскрывает его характер и цели.
  - [ ] *Пример (Воин):* Найти и перековать фамильный меч отца, оскверненный варварами.
  - [ ] *Пример (Торговец):* Восстановить разрушенные торговые пути, заключив союзы с выжившими поселениями.
  - [ ] *Пример (Маг):* Собрать страницы утерянного гримуара, чтобы восстановить утраченные знания.
  - [ ] *Пример (Лучник):* Выследить и одолеть легендарного зверя, который стал угрозой после ухода варваров.

### 2. Влияние на основные и побочные квесты
- [ ] **Альтернативные пути решения:** Наличие определенного спутника в отряде должно предоставлять новые способы прохождения квестов.
  - [ ] **Запертая дверь?** Разбойник может ее взломать, Воин — выбить, а без них — придется искать ключ.
  - [ ] **Древние руны?** Только Маг в отряде сможет их прочитать и раскрыть секрет.
  - [ ] **Напряженные переговоры?** Торговец предоставит уникальные варианты диалога, позволяющие избежать боя.
- [ ] **Скрытые элементы:** Некоторые секреты или сундуки могут быть доступны только при наличии спутника с нужным навыком (например, Охотник замечает скрытые следы).

### 3. Система взаимоотношений и диалогов
- [ ] **Диалоги в отряде (Banter):**
  - [ ] Спутники в активном отряде должны периодически обмениваться репликами во время исследования мира или в бою.
  - [ ] Диалоги должны отражать их характеры и отношения друг к другу (например, подколы между воином и магом).
- [ ] **Диалоги в кузне:**
  - [ ] Спутники, находящиеся на базе, должны взаимодействовать друг с другом, создавая ощущение живого дома.
  - [ ] Игрок может стать свидетелем их разговоров, споров или совместной работы.
- [ ] **Реакция на действия игрока:** Спутники должны комментировать решения игрока в ключевых сюжетных моментах.

### 4. Роль неактивных спутников
- [ ] **Живая кузня:** Спутники, не входящие в активный отряд, не просто стоят на месте, а занимаются деятельностью, соответствующей их классу.
  - [ ] **Торговец:** Открывает лавку, где игрок может покупать и продавать товары по выгодным ценам.
  - [ ] **Воин:** Тренирует ополчение или предлагает спарринги для проверки навыков.
  - [ ] **Маг:** Обустраивает библиотеку или алтарь для зачарования.
  - [ ] **Лучник:** Создает мастерскую по изготовлению стрел и ловушек.

## Технические детали

### Расширение системы квестов и диалогов
```python
# src/quests/quest_system.py
class QuestManager:
    def check_condition(self, condition: QuestCondition) -> bool:
        # ... существующая логика
        if condition.type == "COMPANION_IN_PARTY":
            party_comp = self.player.get_component(PartyManagerComponent)
            return party_comp.has_companion_with_class(condition.class_type)
        # ...

# src/dialogue/dialogue_manager.py
class DialogueManager:
    def get_next_node(self, current_node_id: str, player_choice: int) -> DialogueNode:
        # ...
        # Проверка, есть ли в отряде спутник, открывающий специальную ветку диалога
        if self.quest_manager.check_condition("COMPANION_IN_PARTY", "Trader"):
            # Показать дополнительный вариант ответа
            pass
```

### Структура данных для диалогов (Пример в JSON)
```json
// data/dialogues/trader_banter.json
{
  "id": "trader_mage_banter_1",
  "conditions": [{"type": "COMPANION_IN_PARTY", "id": "mage_brother"}, {"type": "COMPANION_IN_PARTY", "id": "trader_sister"}],
  "lines": [
    { "character": "trader_sister", "text": "Не понимаю, зачем тратить время на эти пыльные книги, когда вокруг столько возможностей заработать!" },
    { "character": "mage_brother", "text": "Не все в этом мире измеряется звоном монет, сестра." }
  ]
}
```

## Критерии готовности
- [ ] Реализована как минимум одна персональная квестовая линия для одного из спутников.
- [ ] В основной сюжет добавлен как минимум один квест с альтернативным решением, зависящим от спутника.
- [ ] Реализована система фоновых диалогов (banter) между двумя спутниками.
- [ ] Неактивные спутники в кузне имеют свою уникальную функцию (торговля, тренировка и т.д.).

## Приоритет
**Средний** - Следующий логический шаг после реализации базовой системы спутников. Значительно повышает глубину мира.

## Зависимости
- **Issue #11 (Система спутников)** - является основой для этой задачи.
- **Issue #09 (Квесты)** - требует доработки для поддержки новых условий.

---

## Подзадачи для реализации

### Фаза 1: Фундамент для интеграции
**Цель**: Доработать существующие системы для поддержки взаимодействия с компаньонами.

- [ ] **1.1. Модификация QuestManager**: Добавить возможность проверки наличия спутника в отряде как условия квеста.
- [ ] **1.2. Модификация DialogueManager**: Добавить логику для отображения условных веток диалога.
- [ ] **1.3. Система персональных квестов**: Создать базовую структуру для хранения и отслеживания личных квестов спутников.

### Фаза 2: Первая полная интеграция (Воин)
**Цель**: Реализовать полный цикл интеграции на примере одного спутника.

- [ ] **2.1. Квест Воина**: Создать и реализовать его персональную квестовую линию.
- [ ] **2.2. Альтернативное решение**: Внедрить в один из существующих квестов вариант прохождения с помощью силы Воина.
- [ ] **2.3. Функция в кузне**: Реализовать механику тренировок, которую Воин предлагает на базе.

### Фаза 3: Система взаимоотношений
**Цель**: Оживить спутников через диалоги.

- [ ] **3.1. Система Banter**: Создать систему, которая триггерит случайные диалоги между членами отряда во время исследования.
- [ ] **3.2. Написание диалогов**: Написать 10-15 вариантов диалогов для разных пар спутников (например, Воин+Маг, Воин+Лучник).
- [ ] **3.3. Диалоги в кузне**: Создать несколько сценок-диалогов для спутников на базе.

### Фаза 4: Расширение на остальных спутников
**Цель**: Применить разработанные механики ко всем остальным братьям и сестрам.

- [ ] **4.1. Персональные квесты**: Реализовать личные квесты для Мага, Торговца, Лучника и Разбойника.
- [ ] **4.2. Квестовые интеграции**: Добавить больше альтернативных решений в основные и побочные квесты.
- [ ] **4.3. Функции в кузне**: Реализовать уникальные функции для всех спутников на базе.