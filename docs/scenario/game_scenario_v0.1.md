# Игровой сценарий: "Последний Кузнец" - Техническая версия
- **Версия:** 0.3 (Техническая детализация с учетом Z-координаты)
- **Автор:** Gemini
- **Дата:** 2025-08-07

---

## ПРОЛОГ: ПЕПЕЛ И ИСКРЫ

### Синопсис
Игрок знакомится с мирной жизнью в кузне, после чего становится свидетелем и участником трагического побега из родной деревни во время нападения варваров. Используя систему туннелей (Z-1), он пересекает свою малую родину под землей, пока на поверхности (Z=0) разворачивается резня, и выходит на свободу в незнакомом лесу.

---

### Сцена 1: Последний урок
- **Локация:** Семейная кузня (Z=0)
- **Тип сцены:** Интерактивная кат-сцена / Обучение
- **Ключевая задача игрока:** Выковать свой первый предмет.
- **Техническая реализация:** (Без изменений, как в v0.2)

---

### Сцена 2: Нападение
- **Локация:** Деревня, Кузня (Z=0)
- **Тип сцены:** Кат-сцена / Управляемый геймплей
- **Ключевая задача игрока:** Добраться до люка в подвал.

- **Описание и ход сцены:**
  Мирную жизнь прерывает рев и крики. Отец, осознав безнадежность ситуации, силой тащит игрока к люку в подвале, приказывая бежать через старый туннель.

- **Техническая реализация и геймплей:**
  - **Триггеры:**
    - `OnQuestCompleted("prologue_01_last_lesson")`: Запускает кат-сцену нападения.
    - `OnPlayerHealthLow(prologue_sequence)`: Запускает кат-сцену, где отец хватает игрока.
    - `OnInteract("tunnel_entrance_hatch")`: Запускает переход на Z-уровень -1.
  - **Системные взаимодействия:**
    - `WorldStateSystem.ChangeState("Peaceful" -> "Raid")`: Активирует `Skybox_Smoky`, `VFX_Fire_Particles`, `SFX_Ambient_Battle`.
    - `EnemySpawner.SpawnGroup("warchiefs_and_orcs")` на Z=0.
    - `DialogueSystem.PlayLine("father_final_words", "В тоннель! К реке! Не оглядывайся! Живи!")`.
    - `WorldStateSystem.SetFlag("FatherBarricadedCellar", true)`.

---

### Сцена 3: Подземный побег
- **Локация:** Туннель под деревней, садом, полем и лесом (Z=-1)
- **Тип сцены:** Интерактивный геймплейный сегмент (побег по туннелю).
- **Ключевая задача игрока:** Двигаться вперед до конца туннеля.

- **Описание и ход сцены:**
  Игрок оказывается в темном туннеле. Он управляет своим персонажем, который движется по заранее проложенной тайловой дорожке на уровне Z=-1. Камера следует за игроком, но рендерит и его (затемненного), и поверхность (Z=0), где видны анимации разрушений, огня и сражающихся NPC. Игрок физически бежит под всем этим ужасом.

- **Техническая реализация и геймплей:**
  - **Триггеры:**
    - `OnInteract("tunnel_entrance_hatch")`: Запускает сцену.
    - `OnEnterZone(trigger_zone_id)`: Активирует скриптовые события на поверхности (Z=0).
    - `OnInteract("tunnel_exit_ladder")`: Завершает сцену.
  - **Системные взаимодействия:**
    - **`ZTransitionSystem.ChangePlayerZLevel(-1)`**: **Ключевая механика.** Игрок перемещается на подземный уровень.
    - `PlayerSystem.ConstrainToPath("escape_tunnel_path")`: Движение игрока ограничено тайлами туннеля.
    - `RenderingSystem.SetLayerVisibility("Z_-1", true)` и `RenderingSystem.SetLayerVisibility("Z_0", true)`: Одновременно рендерятся оба слоя.
    - `RenderingSystem.ApplyEffect("Z_-1", "darkness_tint")`: Слой игрока затемнен.
    - **Скриптовые события на Z=0:**
      - `Zone_Village`: `SFX_Play(Screams, Destruction)`. `VFX_Play(Fire_Small)`.
      - `Zone_Field`: `VFX_Play(Fire_Large_Scale)`. `AmbientMusic.ChangeTrack("burning_village_theme")`.
      - `Zone_Forest_Edge`: `VFX_Play(Flickering_Shadows_From_Fire)`.
      - `Zone_Deep_Forest`: `AmbientMusic.FadeTo("forest_night_theme")`.
  - **UI/UX:**
    - Весь интерфейс скрыт.
  - **Ассеты и окружение:**
    - **Карта:** `village_map` с дополнительным слоем тайлов на Z=-1 для туннеля.
    - **Звуки:** `SFX_Player_Breathing_Heavy`, `SFX_Muffled_Surface_Sounds`.

---

### АКТ I, Глава 1, Сцена 1: У реки
- **Локация:** Берег реки, опушка леса (Z=0)
- **Тип сцены:** Геймплей / Начало Акта I.
- **Ключевая задача игрока:** Прийти в себя и найти укрытие.

- **Описание и ход сцены:**
  Достигнув конца туннеля, игрок поднимается по лестнице и выходит на поверхность из замаскированного люка. Он один, в незнакомом лесу. Игра начинается.

- **Техническая реализация и геймплей:**
  - **Триггеры:**
    - `OnInteract("tunnel_exit_ladder")`: Запускает сцену.
  - **Системные взаимодействия:**
    - **`ZTransitionSystem.ChangePlayerZLevel(0)`**: Игрок возвращается на базовый уровень.
    - `PlayerSystem.RemovePathConstraint()`.
    - `RenderingSystem.SetLayerVisibility("Z_-1", false)`.
    - `QuestSystem.StartQuest("act1_01_survivor", "Найдите безопасное место")`.
  - **UI/UX:**
    - Появляется базовый игровой интерфейс.
  - **Ассеты и окружение:**
    - **Карта:** `starting_forest_map`.
    - **Звуки:** `SFX_River_Flowing`, `SFX_Forest_Ambient`.