# Игровой сценарий: "Последний Кузнец" - Акт I (Расширенная техническая версия)
- **Версия:** 3.0

---

## <a name="toc"></a>Содержание

*   [**Заметки по реализации Z-уровней**](#z-level-notes)
*   [**Пролог: Пепел и Искры**](#prologue)
*   [**Глава 1: У реки**](#chapter1)
*   [**Глава 2: Дорога домой**](#chapter2)
*   [**Глава 3: Город выживших**](#chapter3)
*   [**Глава 4: Первые следы и первая искра**](#chapter4)
*   [**Глава 5: Рефлексия у наковальни**](#chapter5)
*   [**Навигация по сценарию**](#navigation)

---

## <a name="z-level-notes"></a>Заметки по реализации Z-уровней (Ямы, Броды)

*На основе `Issue #02`.*

*   **Ямы/Впадины:** Можно реализовать как небольшие зоны, где Z-уровень игрока временно становится `-0.5`. В отличие от туннелей, у них нет "крыши" (перекрывающих тайлов на Z=0). `RenderingSystem` должен корректно отрисовывать спрайт игрока частично "утопленным" относительно земли. Это может быть чисто визуальным эффектом или влиять на геймплей (например, невозможность атаковать).
*   **Броды/Мелководье:** Реализуются через специальный тип тайла (`shallow_water`). При входе на такой тайл `TerrainSystem` отправляет событие `PlayerEnteredShallowWater`. `PlayerSystem` реагирует, меняя Z-уровень игрока на `-0.2` и применяя дебафф скорости. `RenderingSystem` накладывает полупрозрачный эффект воды на нижнюю часть спрайта игрока.

---

## <a name="prologue"></a>Пролог: Пепел и Искры

### <a name="prologue-scene1"></a>Сцена 1: Последний урок

- **Детальная проработка:**
  - **Локации и Уровни:** `location_family_forge` (интерактивная, с триггерами на наковальне и горне).
  - **Лут и Предметы:** Игрок получает `item_tutorial_nails` (квестовый предмет) после крафта.
  - **Враги и NPC:** `npc_father` (квестодатель, учитель), `npc_sibling_1`, `npc_sibling_2` (фоновые, создают атмосферу).
  - **Триггеры и Переходы:** `OnGameStart` запускает сцену. `OnItemCrafted("item_tutorial_nails")` завершает сцену и запускает триггер следующей.
  - **Технические заметки и Паттерны:** Используется `QuestSystem` (`Issue #09`) для обучающего квеста. Механика крафта — упрощенная версия системы из `Issue #08`.

### <a name="prologue-scene2"></a>Сцена 2: Нападение

- **Детальная проработка:**
  - **Локации и Уровни:** Та же `location_family_forge`, но `WorldStateSystem` переключает ее в состояние "Raid". Активируются `VFX_Fire_Particles`, `SFX_Ambient_Battle`.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** `npc_warchief_1`...`5` (неуязвимые в этой сцене), `npc_orc_grunt` (неуязвимые). Их задача — создать ощущение угрозы.
  - **Триггеры и Переходы:** `OnQuestCompleted("prologue_01_last_lesson")` запускает кат-сцену. `OnInteract("tunnel_entrance_hatch")` является `EventBox` (`Issue #07`) и триггером для перехода на сцену 3.
  - **Технические заметки и Паттерны:** `State Pattern` (`Issue #05`) для NPC, переключающихся из мирного состояния в панику. `PlayerSystem` устанавливает неуязвимость и нулевой урон для игрока на время этой сцены.

### <a name="prologue-scene3"></a>Сцена 3: Подземный побег

- **Детальная проработка:**
  - **Локации и Уровни:** Используется карта `village_map_destroyed`. Игрок находится на Z=-1, двигаясь по заранее определенному пути `escape_tunnel_path`. На Z=0 происходят скриптовые события.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** На Z=0 анимированные спрайты `npc_orc_grunt` и `npc_villager` разыгрывают сцены боя.
  - **Триггеры и Переходы:** `OnPathNodeReached(node_id)` запускает скриптовые события на поверхности. `OnPathEnd("escape_tunnel_path")` завершает пролог и загружает `starting_forest_map`.
  - **Технические заметки и Паттерны:** Ключевая механика — `ZTransitionSystem` и `PlayerSystem.ConstrainToPath` (`Issue #02`). `RenderingSystem` должен поддерживать одновременную отрисовку двух Z-уровней.

---

## <a name="chapter1"></a>Глава 1: У реки

### <a name="chapter1-scene1"></a>Сцена 1: Новый мир

- **Детальная проработка:**
  - **Локации и Уровни:** `starting_forest_map` — новая карта. Содержит реку, лес, поляну с выходом из туннеля.
  - **Лут и Предметы:** Интерактивные объекты `item_sturdy_branch` и `item_thorny_bush`, которые при поднятии превращаются в `weapon_club_makeshift` и `shield_bush_makeshift` (`Issue #04`, `Issue #08`).
  - **Враги и NPC:** Нет.
  - **Триггеры и Переходы:** `OnSceneStart` (после Пролога) запускает квест.
  - **Технические заметки и Паттерны:** `QuestSystem` (`Issue #09`) используется для обучения основам.

### <a name="chapter1-scene2"></a>Сцена 2: Первая ночь

- **Детальная проработка:**
  - **Локации и Уровни:** Та же `starting_forest_map`. На карте есть несколько предопределенных `campfire_spot` (EventBox).
  - **Лут и Предметы:** Игрок должен собрать `resource_firewood` с интерактивных деревьев.
  - **Враги и NPC:** Ночью могут спавниться слабые `enemy_wolf_small`.
  - **Триггеры и Переходы:** `OnInteract("campfire_spot")` с нужными ресурсами запускает кат-сцену отдыха.
  - **Технические заметки и Паттерны:** `WorldStateSystem` управляет циклом дня и ночи. `EnemySpawner` (`Issue #05`) активируется ночью.

---

## <a name="chapter2"></a>Глава 2: Дорога домой

### <a name="chapter2-scene1"></a>Сцена 1: Возвращение

- **Детальная проработка:**
  - **Локации и Уровни:** Переход с `starting_forest_map` на `village_map_destroyed_populated`.
  - **Лут и Предметы:** С врагов падает `resource_leather_scraps`, `item_healing_salve_weak`.
  - **Враги и NPC:** `enemy_bandit_thug`, `enemy_wolf_adult`.
  - **Триггеры и Переходы:** `OnEnterZone("village_outskirts_trigger")` загружает новую карту.

### <a name="chapter2-scene2"></a>Сцена 2: Восстановление основ

- **Детальная проработка:**
  - **Локации и Уровни:** Зона `forge_ruins` на карте `village_map_destroyed_populated`.
  - **Лут и Предметы:** Квестовые предметы: `item_fathers_hammer`, `item_bellows_torn`. Ресурсы: `resource_iron_ore` в развалах.
  - **Враги и NPC:** Нет.
  - **Триггеры и Переходы:** `OnItemCrafted("item_iron_dagger")` завершает главу.
  - **Технические заметки и Паттерны:** Используется `CraftingSystem` (`Issue #08`) для создания первого металлического предмета.

---

## <a name="chapter3"></a>Глава 3: Город выживших

### <a name="chapter3-scene1"></a>Сцена 1: Прибытие в "Приют"

- **Детальная проработка:**
  - **Локации и Уровни:** Новая карта `city_hub`.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** Множество фоновых `npc_refugee`, `npc_guard`, `npc_merchant_generic`. Ключевой NPC — `npc_elias_the_trader`.
  - **Триггеры и Переходы:** `OnEnterZone("city_gate_trigger")`.

### <a name="chapter3-scene2"></a>Сцена 2: Лицо из прошлого

- **Детальная проработка:**
  - **Локации и Уровни:** Интерактивная зона `elias_shop`.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** `npc_elias_the_trader`.
  - **Триггеры и Переходы:** `OnEnterZone("elias_shop")` запускает диалог.
  - **Технические заметки и Паттерны:** `DialogueSystem` (`Issue #09`) с ветвлением.

### <a name="chapter3-scene3"></a>Сцена 3: Искра надежды

- **Детальная проработка:**
  - **Локации и Уровни:** Та же лавка.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** `npc_elias_the_trader`.
  - **Триггеры и Переходы:** `OnDialogueNodeReached("elias_main_revelation")` запускает кат-сцену и новый главный квест.
  - **Технические заметки и Паттерны:** `QuestSystem` переключает основной квестовый вектор игрока.

---

## <a name="chapter4"></a>Глава 4: Первые следы и первая искра

### <a name="chapter4-scene1"></a>Сцена 1: Гиблые топи

- **Детальная проработка:**
  - **Локации и Уровни:** Новая карта `swamp_map` с использованием механики бродов (Z=-0.2) и ям с грязью (замедление).
  - **Лут и Предметы:** Квестовые улики: `clue_torn_cloth`, `clue_campfire_ashes`, `clue_broken_arrow`.
  - **Враги и NPC:** Новые враги `enemy_swamp_leech`, `enemy_poisonous_fly`.

### <a name="chapter4-scene2"></a>Сцена 2: Битва за брата

- **Детальная проработка:**
  - **Локации и Уровни:** Зона `bandit_camp` на карте `swamp_map`.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** Мини-босс `bandit_leader_boris` (использует `State Pattern` с фазами атаки и защиты), `npc_brother_warrior_captured`.

### <a name="chapter4-scene3"></a>Сцена 3: Таинственный лут

- **Детальная проработка:**
  - **Локации и Уровни:** Та же `bandit_camp`.
  - **Лут и Предметы:** **Ключевой лут:** `LootSystem` (`Issue #08`) по триггеру `OnEnemyKilled("bandit_leader_boris")` гарантированно выдает `item_notched_axe_socketed` и `item_ember_amber`.
  - **Враги и NPC:** Спасенный `npc_brother_warrior`.
  - **Триггеры и Переходы:** `OnItemEnhanced` запускает квест-открытие.
  - **Технические заметки и Паттерны:** `Decorator Pattern` (`Issue #08`) используется для добавления огненного эффекта к топору.

---

## <a name="chapter5"></a>Глава 5: Рефлексия у наковальни

### <a name="chapter5-scene1"></a>Сцена 1: Возвращение домой и новая цель

- **Детальная проработка:**
  - **Локации и Уровни:** `location_family_forge`.
  - **Лут и Предметы:** Нет.
  - **Враги и NPC:** `npc_brother_warrior` (теперь как спутник, `Issue #11`).
  - **Триггеры и Переходы:** `OnEnterZone("home_forge_with_brother")` запускает финальный диалог акта.
  - **Технические заметки и Паттерны:** `OnDialogueNodeReached("player_realization_node")` разблокирует новую систему через `UISystem.UnlockFeature("Journal_Research_Tab")` и запускает главный квест-исследование через `QuestSystem`.

---

## <a name="navigation"></a>Навигация по сценарию

*   **[К содержанию](./game_scenario_index.md)**
*   **[К Акту II](./game_scenario_act2_v0.1.md)** (файл будет создан)
